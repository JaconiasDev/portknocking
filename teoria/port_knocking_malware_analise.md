AGORA VAMOS VER A TÉCNICA DE PORT KNOCKING PELO OLHAR DE UM ANALISTA DE REDE OU ATÉ DE UM ANALISTA DE MALWARE<br>

COMO VIMOS NA EXPLICAÇÃO DO MALWARE NA AULA DE ANÁLISE DE MALWARE, ELE USA A TÉCNICA DE PORT KNOCKING ATIVO PRA SE COMUNICAR COM O C2.<br>

AGORA IMAGINE QUE VOCÊ É UM ANALISTA DE REDE E SOUBE QUE O HOST [192.168.0.15] FOI INFECTADO.<br>

VOCÊ, COMO ANALISTA DE REDE, JÁ DEVE SABER QUE, A ESSA ALTURA, O MALWARE POSSUI UM C2. PORÉM, VOCÊ PRECISA ANALISAR O TRÁFEGO DA SUA REDE PRA TENTAR IDENTIFICAR, NO MEIO DESSE TRÁFEGO, ALGUMA POSSÍVEL<br> EXFILTRAÇÃO DE DADOS OU ATÉ A COMUNICAÇÃO COM UM HOST EXTERNO DESCONHECIDO (C2).<br>

CENÁRIO:<br>
HOST IDENTIFICADO DIA 13 - CASO CHEGOU AO ANALISTA NO DIA 14.<br>
ANALISTA DE REDE DEVE OBSERVAR O TRÁFEGO DO DIA 13 E 14 PRA IDENTIFICAR ALGO SOBRE O MALWARE (SE PASSIVO OU ATIVO).<br>

AGORA IMAGINE QUE VOCÊ, COMO ANALISTA DA REDE, FOI ANALISAR A REDE E VIU QUE O HOST [192.168.0.15](VÍTIMA) PASSOU A ENVIAR OU A GERAR TRÁFEGO NA REDE PRA UM SERVIDOR EXTERNO E DESCONHECIDO, COMO NESSE EXEMPLO:<br>

> [00523]-[192.168.0.15:6790]-[PDST=13]-[SYN] => [39.59.34.145]<br>

O NOSSO HOST [192.168.0.15](VÍTIMA) PASSOU A ENVIAR PACOTES DE SINCRONIZAÇÃO A UM SERVIDOR EXTERNO/DOMÍNIO DIFERENTE DO NORMAL, QUE É O SERVIDOR [39.59.34.145].<br>

PORÉM, HÁ MUITOS TRÁFEGOS PARA ESSE SERVIDOR. ENTÃO VEMOS QUE NOSSO HOST SE COMUNICA COM ESSE SERVIDOR EXTERNO NA PORTA 1337. VOCÊ, COMO ANALISTA DA REDE, TENTA ENVIAR ALGO COMO UM PACOTE DE <br>SINCRONIZAÇÃO [SYN] PRA ESSE SERVIDOR NESSA PORTA/SERVIÇO, PORÉM NÃO TEM 3-WAY COM ESSA PORTA (CONEXÃO NÃO É ESTABELECIDA).<br>

AÍ JÁ É UM PROBLEMA, PORQUE ESTAMOS VENDO O TRÁFEGO DE TUDO E ATÉ TROCA DE [SYN/ACK] DO MEU HOST COM O SERVIDOR C2 DO ATACANTE (PORTA PROVAVELMENTE JÁ FOI FECHADA APÓS EXFILTRAÇÃO).<br>

BOM, COM ESSES PEQUENOS DETALHES, PODEMOS IDENTIFICAR SE ESSE MALWARE ESTÁ USANDO ESSA TÉCNICA DE PORT KNOCKING ATIVO, ASSIM:<br>

ANTES DE TODAS AS CONEXÕES, ANTES DO MEU HOST ENVIAR DADOS A ESSE SERVIDOR OU RECEBER DADOS (COMANDOS) DO SERVIDOR DO ATACANTE, PODEMOS OBSERVAR SE, ANTES DO PRIMEIRO 3-WAY, ELE ENVIA PACOTES DE [SYN] PARA O SERVIDOR EXTERNO, ANTES DE ELE DE FATO SE CONECTAR EM UMA PORTA DESSE SERVIDOR (C2).<br>

SE ISSO ACONTECE E VOCÊ IDENTIFICAR ESSA SEQUÊNCIA DE CARA, VOCÊ JÁ PERCEBE QUE O MALWARE USA ESSA TÉCNICA DE (PORT KNOCKING). COM ISSO, JÁ SABEMOS QUE, SE O NOSSO HOST GERA TRÁFEGO, OU <br>NOSSO HOST QUE ENVIA PACOTES DE [SYN] PRA O C2 DA VÍTIMA, PODEMOS BATER O MARTELO E DIZER QUE ESSE MALWARE USA A TÉCNICA DE PORT KNOCKING ATIVO, ONDE O MALWARE GERA O TRÁFEGO, OU SEJA,<br> ENVIA OS PACOTES DE [SYN] PRA O C2. AÍ O C2 IDENTIFICA ESSE PADRÃO ESPECÍFICO DE PORTAS, ABRINDO A PORTA NO C2, E NOSSO HOST INFECTADO SE CONECTA NELE. COMO VISTO NA EXPLICAÇÃO, O MALWARE PODE USAR O PORT KNOCKING DE 2 FORMAS: DE FORMA PASSIVA E ATIVA.<br>

PORÉM, A COISA NÃO É TÃO SIMPLES ASSIM, PELO FATO DE QUE O ATACANTE/DESENVOLVEDOR DO MALWARE ESTABELECERIA ESSES PADRÕES DE PORTAS E TEMPO DE BATIDA ENTRE ELAS (TEMPO EM QUE UM PACOTE <br>[SYN] VAI SER ENVIADO PRA UMA PORTA)! POR EXEMPLO, ELE PODE DEFINIR UM PADRÃO DE PORTAS BEM ALEATÓRIAS E COM UM INTERVALO DE TEMPO DE 2 SEGUNDOS, POR EXEMPLO!<br>

ISSO DIFICULTARIA UM POUCO NOSSA ANÁLISE, PELO FATO DE QUE, ANTES, O HOST ENVIAVA OS PACOTES DE [SYN] PRA O C2 MUITO RÁPIDO, COM MENOS DE 1 SEGUNDO ENTRE CADA VEZ QUE FOI ENVIADO O PACOTE<br> DE [SYN], O QUE SERIA VISIVELMENTE FÁCIL DE IDENTIFICAR. MAS IMAGINE QUE O DESENVOLVEDOR DO MALWARE COLOQUE UM PADRÃO DE PORTAS COM UM TEMPO DE 2 SEGUNDOS ENTRE CADA BATIDA/ENTRE CADA VEZ QUE ENVIA O PACOTE DE [SYN]. ISSO SERIA MAIS DIFÍCIL DE IDENTIFICAR NA REDE, PORQUE NUMA REDE GRANDE ELE GERA MUITO TRÁFEGO DENTRO DE 2 SEGUNDOS, O QUE MEIO QUE <br>ESCONDERIA A PRIMEIRA BATIDA DE PORTA; DEPOIS DE MAIS 2 SEGUNDOS, BATIA NA PRÓXIMA PORTA, DEPOIS MANDAVA OUTRO PACOTE [SYN] PRA O C2. TUDO ISSO SEGUINDO UM PADRÃO DE PORTAS E TEMPO ESPECÍFICOS DEFINIDOS PELO ATACANTE. MEIO QUE SERIA ASSIM SE UM MALWARE USASSE A TÉCNICA DE PORT KNOCKING COM UM INTERVALO DE 2 SEGUNDOS ENTRE ELES:<br>

> [00523]-[192.168.0.15:6790]-[PDST=13]-[SYN] => [39.59.34.145] // ESPERA 2 SEGUNDOS PRA BATER NA PRÓXIMA PORTA \
TRÁFEGO DE OUTRAS COISAS\
> [00623]-[192.168.0.15:7654]-[PDST=37]-[SYN] => [39.59.34.145] // ESPERA 2 SEGUNDOS PRA BATER NA PRÓXIMA PORTA\
TRÁFEGO DE OUTRAS COISAS\
> [00723]-[192.168.0.15:9876]-[PDST=30000]-[SYN] => [39.59.34.145] // ESPERA 2 SEGUNDOS PRA BATER NA PRÓXIMA PORTA\
TRÁFEGO DE OUTRAS COISAS\
> [00823]-[192.168.0.15:1235]-[PDST=3000]-[SYN] => [39.59.34.145] // ESPERA 2 SEGUNDOS PRA BATER NA PRÓXIMA PORTA\

COM ISSO, O C2 DO ATACANTE, COM SEU DAEMON, IDENTIFICA ESSE PADRÃO DE PORTAS DENTRO DE UM ESPAÇO DE 2 SEGUNDOS ENTRE CADA BATIDA (KNOCKING), E ISSO É USADO DA MESMA FORMA NO MODO ATIVO.<br>O QUE MUDA É QUE, NO MODO PASSIVO, O HOST QUE GERA TRÁFEGO É O HOST DO ATACANTE, ONDE ELE ENVIA/BATE NO PADRÃO ESPECÍFICO DE PORTAS NA REDE INFECTADA COM O INTERVALO ESPECÍFICO DELE.<br> POR EXEMPLO, NO MODO PASSIVO DE PORT KNOCKING, O ATACANTE ENVIARIA DE 2 EM 2 SEGUNDOS UM PACOTE [SYN] PRA O MEU HOST INFECTADO (ELE SABERIA O IP POR MEIO DE ENG. SOCIAL, POR EXEMPLO) <br>- (A VÍTIMA PODERIA ESTAR COM FIREWALL, QUE MESMO ASSIM OS PACOTES [SYN] CHEGARIAM, POIS O MALWARE ANALISARIA O TRÁFEGO A UM NÍVEL MUITO BAIXO) AO MALWARE, JÁ QUE ELE ESCUTA TUDO NA <br>INTERFACE DE REDE DO HOST DA VÍTIMA, SÓ ESPERANDO A SEQUÊNCIA VINDA DO ATACANTE.<br>

COMO SE:<br>
NOSSO HOST INFECTADO É O HOST [192.168.0.15]. PORÉM, COMO SABEMOS, O ATACANTE NÃO VAI ENVIAR PACOTES PARA O IP INTERNO, PORQUE ELE É VISTO APENAS NA LAN, E SEMPRE QUE QUERO ACESSAR A <br>INTERNET, O ROTEADOR FAZ O NAT DO MEU ENDEREÇO INTERNO PRA ENDEREÇO EXTERNO DO ROTEADOR/END. PÚBLICO.<br>

COM ISSO, PRA O ATACANTE ENVIAR PACOTES PRA ESSE HOST INFECTADO, ELE ENVIA PRA O IP DO ROTEADOR (IP PÚBLICO), ONDE O ROTEADOR RECEBE ESSES PACOTES DE [SYN] E FAZ O NAT PRA O MEU HOST <br>INFECTADO, ONDE ELE FICA ESCUTANDO A INTERFACE DA REDE, PERCEBENDO O PADRÃO DE PORTAS SEGUIDAS PELO PADRÃO DE TEMPO ENTRE ELAS, E ENTÃO VÊ ESSE PADRÃO QUE O ATACANTE ESTÁ ENVIANDO, E <br>ENTÃO EXECUTA O BACKDOOR - (LISTEN() / BIND()) ONDE ELE ABRE UMA PORTA NO HOST INFECTADO, E O HOST ATACANTE SE CONECTA A ESSA PORTA PRA FAZER O REVERSE SHELL.<br>

E ASSIM QUE DEVERÍAMOS ANALISAR, SEMPRE FOCANDO NOS PONTOS IMPORTANTES, COMO:
SEQUÊNCIA SUSPEITA DE VÁRIOS [SYN] QUE PEDE PRA SINCRONIZAR, MAS NÃO SINCRONIZAM.
VÁRIAS PORTAS DIFERENTES COM TENTATIVAS DE [SYN]. EX: PDST=13 PDST=37 - NENHUM SERVIDOR USA UM SERVIÇO NESSAS PORTAS, E GERALMENTE SERVIDORES TÊM SEUS SERVIÇOS EM PORTAS ALTAS, TENDO SERVIÇOS EM PORTAS ABAIXO DE 1024, COMO FTP=21, SSH=22, ETC...
SE IDENTIFICADO UM PADRÃO SUSPEITO DE PORTAS, DEVE-SE OBSERVAR O INTERVALO ENTRE ELAS.
PORQUE IMAGINE QUE IDENTIFIQUEI O PADRÃO DE 13 - 37 - 45 - 3000. TODAS ESSAS PORTAS SÓ FIZERAM OU ENVIARAM PACOTE [SYN] PRA O SERVIDOR [39.59.34.145] SEM TER UM 3-WAY DEPOIS. PORÉM, PRA CONCRETIZAR SE ISSO DE FATO É UM PADRÃO DE PORTAS USADO PRA ATIVAR A PORTA PRINCIPAL DO C2, PODEMOS PEGAR TODOS ESSES PACOTES DE [SYN] 13 - 37 - 45 - 3000 E SUBTRAIR O TIME PELO ANTERIOR PRA VER SE TEM UM PADRÃO ENTRE ELES, POR EXEMPLO:


>[00523]-[192.168.0.15:6790]-[PDST=13]-[SYN] => [39.59.34.145]\
>[00623]-[192.168.0.15:7654]-[PDST=37]-[SYN] => [39.59.34.145]\
>[00723]-[192.168.0.15:9876]-[PDST=30000]-[SYN] => [39.59.34.145]\
>[00823]-[192.168.0.15:1235]-[PDST=3000]-[SYN] => [39.59.34.145]\

*COM ISSO, IMAGINEMOS QUE O PADRÃO QUE IDENTIFICAMOS FOI ESSE. VAMOS SUBTRAIR O TIME DE UM PELO PRÓXIMO, ASSIM:

>TIME2 - TIME1 = 623 - 523 = 100MS\
>TIME3 - TIME2 = 723 - 623 = 100MS\
>TIME4 - TIME3 = 823 - 723 = 100MS\

OU SEJA, IDENTIFICAMOS UM PADRÃO AQUI, ONDE, DE 100MS, O HOST INFECTADO BATE NA PORTA/ENVIA PACOTES PRA O C2 EM PORTAS ESPECÍFICAS. PARA O TIME, SÓ ESSA SEQUÊNCIA JÁ É O SUFICIENTE, PORQUE DEPOIS DO NOSSO HOST INFECTADO BATER EM TODAS AS PORTAS, O SERVIDOR C2 ABRE A PRINCIPAL, QUE NOSSO HOST, EM SEGUIDA, SE CONECTA NELA E COMEÇA A EXECUÇÃO REMOTA/REVERSE SHELL.
