# - PORT KNOCKING USADO PRA ATIVAR C2 DO MALWARE

#   RELEMBRANDO O PORT KNOCKING 

# - JÁ VIMOS NA PARTE DE CONHECIMENTO SOBRE ESSA TÉCNICA E JÁ SABEMOS COMO USÁ-LA NO LADO DE SEGURANÇA DA NOSSA REDE,
# - PORÉM ESSA TÉCNICA TAMBÉM PODE SER USADA PRA ATIVAR MALWARES COM C2, ISSO MESMO.
# - E ESSA TÉCNICA É BEM COMUM DE SER USADA PRA ATIVAR C2, MAS OBVIAMENTE COM MAIS CAMADAS DE BYPASS PRA FICAR O MAIS IRRRASTREÁVEL OU DIFÍCIL DE IDENTIFICAR NA REDE.
# - PORÉM VAMOS RELEMBRAR QUE ESSA TÉCNICA CONSISTE EM BATER EM UMA SEQUÊNCIA DE PORTAS (UM PADRÃO DE PORTAS) ESPECÍFICAS NO MEU SERVIDOR PRA QUE UM SERVIÇO
# - VENHA SER ABERTO NO SERVIDOR POR MEIO DO NOSSO DAEMON (SERVIÇO EM SEGUNDO PLANO QUE FICA ESCUTANDO A INTERFACE DE REDE DO NOSSO SERVIDOR EM UM NÍVEL LAYER).
# - E CASO ELE IDENTIFIQUE ESSE PADRÃO DE PORTAS NA INTERFACE DE REDE DO SERVIDOR, ELE ABRE O SERVIÇO PRA SER USADO.

# - COMO FUNCIONA ESSA TÉCNICA PRA ATIVAR MALWARES COM C2? 

# --------------------------------------------------------------------------------------------------------------------------------------------

#                                  TIPO (A) - MALWARE USANDO TÉCNICA DE PORT KNOCKING ATIVO - MAIS MODERNO
# - CARACTERÍSTICAS:
# - MALWARE GERA TRÁFEGO NA REDE ENVIANDO PACOTE DE SINCRONIZAÇÃO [SYN] PRA O C2
# - A PORTA NO SERVIDOR C2 SÓ É ABERTA APÓS A SEQUÊNCIA CORRETA DE (PORTAS) SEREM BATIDAS.
# - NENHUMA PORTA NO HOST DA VÍTIMA É ABERTA, POIS O MALWARE QUE SE COMUNICA COM O C2.
# - BOTSNETS
# - EVASÃO DE FIREWALLS
# --------------------------------------------------------------------------------------------------------------------------------------------

# - AGORA VAMOS ENTENDER DE FATO COMO ESSA TÉCNICA FUNCIONA. BASICAMENTE PODEMOS IMAGINAR QUE: UM USUÁRIO NA MINHA REDE FOI INFECTADO,
# - DIGAMOS QUE FOI O HOST DA MINHA REDE LAN (REDE INTERNA) [192.168.0.15].
# - ESSE HOST FOI INFECTADO COM UM MALWARE_QUE_TEM_UM_C2. PORÉM, ATÉ AÍ TUDO "BEM", NÃO ACONTECEU NADA COM O NOSSO HOST INFECTADO, NADA FOI
# - PERDIDO, NÃO HOUVE NENHUMA ATIVIDADE SUSPEITA DESSE HOST INFECTADO.
# - PORÉM É BOM LEMBRARMOS QUE A MAIORIA DESSES TIPOS DE MALWARES POSSUEM A TÉCNICA DE DORMIR (SLEEP()) DURANTE UM TEMPO PRA NÃO LEVANTAR
# - SUSPEITAS NO SO OU NA REDE.
# - E DEPOIS DE UM TEMPO, POR EXEMPLO, DEPOIS DE 1 MINUTO DORMINDO OU INATIVO, ELE É EXECUTADO NA MÁQUINA, GERALMENTE ASSOCIADO COMO UM SOFTWARE LEGÍTIMO (ATRELADO A DLLS).
# - COM ELE ATIVO, DEPOIS DE "ACORDADO", COMEÇA A ATIVIDADE MALICIOSA, MAS NÃO VAMOS NOS APROFUNDAR NISSO AQUI, ATÉ PORQUE ESTAMOS FOCADOS APENAS NUMA PEQUENA PARTE
# - INICIAL DA EXECUÇÃO DO MALWARE, QUE É A TÉCNICA DE (PORT_KNOCKING ATIVO).
# - BASICAMENTE E RESUMIDAMENTE, QUANDO O HOST É INFECTADO, O MALWARE FICA INATIVO POR UM TEMPO (EM EXECUÇÃO COMO SOFTWARE LEGÍTIMO, COMO EXPLORER, PORÉM A PARTE MALICIOSA ESTÁ DORMINDO POR UM TEMPO) E DEPOIS É EXECUTADO,
# - ONDE, DEPOIS DE ACORDAR, ELE EXECUTA E FAZ A TENTATIVA DE SE COMUNICAR COM O C2 (SERVIDOR DE COMANDO E CONTROLE) DO ATACANTE, E A TÉCNICA DE PORT KNOCKING ENTRA
# - BEM AÍ NA HORA QUE O MALWARE "ACORDA".
# - PORQUE O SERVIDOR C2 DO ATACANTE VAI FICAR ESPERANDO, ASSIM COMO UM SERVIDOR NORMAL QUE USE ESSA TÉCNICA DE PORT KNOCKING, UMA SEQUÊNCIA OU
# - UM PADRÃO ESPECÍFICO DE PORTAS PRA PODER SE CONECTAR AO SERVIDOR.
# - NESSE NOSSO EXEMPLO, O C2 DO ATACANTE POSSUI ESSA TÉCNICA TAMBÉM, ONDE O C2 FICA ESPERANDO O MALWARE ENVIAR A SEQUÊNCIA OU O PADRÃO
# - ESPECÍFICO DE PORTAS PRA QUE O MALWARE CONSIGA SE CONECTAR AO C2 (FORMA ATIVA).
# - EM VISÃO DO MALWARE, ELE JÁ FOI DESENVOLVIDO COM ESSE MECANISMO DE QUE, QUANDO ELE FOR EXECUTADO, ELE ENVIE, POR EXEMPLO, PACOTES
# - DE SINCRONIZAÇÃO [SYN] PRA O SERVIDOR DE COMANDO E CONTROLE [C2]/DOMÍNIO PRA QUE O ATACANTE CONSIGA SE COMUNICAR OU EXECUTAR COMANDOS REMOTAMENTE,
# - ASSIM EXTRAINDO INFORMAÇÕES, INSTALANDO MAIS MALWARES!!!
# - EXEMPLO:
# - 
# - [192.168.0.15] = MEU HOST INFECTADO / O TRÁFEGO A SEGUIR DESSE HOST É DO MALWARE, OU É O MALWARE QUE GERA.
# - [39.59.34.145] = C2 - SERVIDOR DO ATACANTE QUE ELE USA PRA EXECUTAR COMANDOS REMOTAMENTE POR MEIO DO MALWARE.
# -
# - [00523]-[192.168.0.15:6790]-[PDST=13]-[SYN] => [39.59.34.145] // O IP DO SERVIDOR C2 PODE ESTAR SENDO ESCONDIDO POR UM PROXY, ESCONDENDO
# - [00623]-[192.168.0.15:7654]-[PDST=37]-[SYN] => [39.59.34.145] // O SERVIDOR REAL.
# - [00723]-[192.168.0.15:9876]-[PDST=30000]-[SYN] => [39.59.34.145]
# - [00823]-[192.168.0.15:1235]-[PDST=3000]-[SYN] => [39.59.34.145]

# - ESSE SERIA UM TRÁFEGO QUE O MALWARE DEIXARIA NA REDE AO TENTAR SE CONECTAR AO C2 USANDO A TÉCNICA DE PORT KNOCKING ATIVO (BATER NA PORTA DO C2).
# - PORÉM, COMO FALEI ANTERIORMENTE, TUDO DENTRO DE UMA SEQUÊNCIA ESPECÍFICA DE PORTAS E DENTRO DE UM TIME ESPECÍFICO / LINHA DE TEMPO ESPECÍFICO
# - PRA QUE A COMUNICAÇÃO DO MALWARE COM O C2 POSSA SER FEITA COM SUCESSO. POR EXEMPLO, LOGO APÓS O MALWARE
# - MANDAR ESSES PACOTES DE SINCRONIZAÇÃO [SYN] PRA O C2, O C2 VAI ABRIR UMA PORTA ESPECÍFICA NO SERVIDOR, ONDE O MALWARE, APÓS ENVIAR
# - ESSE PADRÃO DE PORTAS, VAI ABRIR UMA PORTA ESPECÍFICA NO SERVIDOR QUE VAI SER USADA PELO MALWARE PRA SE COMUNICAR COM O C2 E FAZER O REVERSE SHELL.
# - 
# - [00523]-[192.168.0.15:6790]-[PDST=13]-[SYN] => [39.59.34.145]
# - [00623]-[192.168.0.15:7654]-[PDST=37]-[SYN] => [39.59.34.145]
# - [00723]-[192.168.0.15:9876]-[PDST=30000]-[SYN] => [39.59.34.145]
# - [00823]-[192.168.0.15:1235]-[PDST=3000]-[SYN] => [39.59.34.145]
# - A SEQUÊNCIA DE PORTAS FOI ENVIADA COM SUCESSO (13,37,30000, 3000) E SEGUINDO A SEQUÊNCIA ESPECÍFICA E UM TIME PEQUENO. COM ISSO, AGORA O MALWARE
# - VAI MANDAR UM PACOTE [SYN] PRA PORTA QUE SE ABRIU NO C2 PRA CONEXÃO ENTRE MALWARE E C2 SEREM ESTABELECIDAS.
# - [00923]-[192.168.0.15:3465]-[PDST=1337]-[SYN] => [39.59.34.145] // MANDA [SYN] PRA PORTA 1337 DO C2 QUE SE ABRIU.
# - [00950]-[39.59.34.145]-[PDST=3465]-[SYN/ACK] => [192.168.0.15] // SINCRONIZA.
# - [00991]-[192.168.0.15:3465]-[PDST=1337]-[RST] => [39.59.34.145] // ENCERRA CONEXÃO.

# - OBS: UMA OBSERVAÇÃO IMPORTANTE DESSE MALWARE COM A TÉCNICA DE PORT KNOCKING ATIVO É QUE, SE NÓS VEMOS O TRÁFEGO NA REDE E VEMOS QUE ELE SE COMUNICA
# - COM UM HOST EXTERNO (C2) E TENTARMOS NOS CONECTAR NA PORTA 1337 DO C2 DO ATACANTE, ISSO NÃO VAI SER POSSÍVEL, POIS TEMOS QUE PASSAR A SEQUÊNCIA ESPECÍFICA
# - DE PORTAS PRA QUE O SERVIDOR C2 IDENTIFIQUE O PADRÃO E ABRA ESSA PORTA, PORQUE ATÉ ENTÃO ELA É SEMPRE FECHADA E SÓ ABRE QUANDO ESSE PADRÃO É VISTO
# - NA INTERFACE DE REDE DO C2.
# - OU SEJA, A PORTA 1337 ELA NÃO ESTÁ ABERTA NO C2. ELA SÓ É ABERTA DEPOIS DO PADRÃO DE BATIDAS - KNOCKING SER RECONHECIDO PELO DAEMON DO C2 DO ATACANTE.

# --------------------------------------------------------------------------------------------------------------------------------------------

#                                  TIPO (B) - MALWARE USANDO TÉCNICA DE PORT KNOCKING PASSIVO - ANTIGO
# - CARACTERÍSTICAS:
# - O ATACANTE ENVIA PACOTES DE [SYN] PRA O HOST INFECTADO, INDEPENDENTE DE ONDE ELE ESTÁ (FIREWALL / NAT).
# - O MALWARE ESCUTA NA INTERFACE DE REDE DA VÍTIMA/HOST INFECTADO PRA DETECTAR O PADRÃO ESPECÍFICO DE PORTAS.
# - O MALWARE, APÓS IDENTIFICAR O PADRÃO, ABRE UM BACKDOOR NO HOST INFECTADO.
# - MALWARES ANTIGOS.
# - AMBIENTES SEM NAT.
# - BACKDOORS ANTIGOS.
# --------------------------------------------------------------------------------------------------------------------------------------------

# - MALWARES TAMBÉM PODEM USAR ESSA TÉCNICA DE PORT KNOCKING DE FORMA PASSIVA, OU SEJA, QUEM VAI GERAR O TRÁFEGO NÃO É O MALWARE E SIM O ATACANTE.
# - BASICAMENTE É O INVERSO DO MODO ATIVO E DO MODO PADRÃO DE PORT KNOCKING. O MODO PADRÃO, A GENTE PASSA OU ENVIA O PADRÃO ESPECÍFICO E A PORTA É ABERTA,
# - ASSIM CONSEGUINDO SE CONECTAR. PORÉM, NO MODO PASSIVO, COMO JÁ DITO, O ATACANTE ENVIA OS PACOTES DE SINCRONIZAÇÃO. E COMO SE MEU HOST [192.168.0.15] FOI INFEC-
# - TADO, AÍ O QUE ACONTECE? O MALWARE SERÁ EXECUTADO NO HOST DA VÍTIMA, E COMO SABEMOS, ELE FOI CRIADO E DESENVOLVIDO COM ESSE OBJETIVO DE, DEPOIS DE EXECUTADO NO HOST,
# - ELE COMECE A OUVIR A INTERFACE DE REDE DO HOST QUE ELE ESTÁ SENDO EXECUTADO PRA IDENTIFICAR O PADRÃO ESPERADO, PRA DEPOIS DE IDENTIFICAR ESSE PADRÃO, ELE
# - EXECUTA O BACKDOOR COM UM LISTEN() OU BIND() QUE ABRE UMA PORTA NO NOSSO HOST (EX:1337), QUE É A PORTA QUE O ATACANTE VAI SE COMUNICAR E FAZER O REVERSE SHELL.

# - EXEMPLO:
# -  TIME  | IP ORIGEM E PORTA  | PORTA DESTINO | FLAGS | IP DESTINO 
# - [00523]-[39.59.34.145:3456]-[PDST=13]-[SYN] => [192.168.0.15]
# - [00530]-[39.59.34.145:3480]-[PDST=37]-[SYN] => [192.168.0.15]
# - [00550]-[39.59.34.145:3434]-[PDST=30000]-[SYN] => [192.168.0.15]
# - [00580]-[39.59.34.145:3423]-[PDST=3000]-[SYN] => [192.168.0.15]
# - 
# - DEPOIS DESSE PADRÃO SER IDENTIFICADO PELO HOST INFECTADO, O BACKDOOR É EXECUTADO, ABRINDO A PORTA EX: 1337.
# - DEPOIS DE O BACKDOOR ABRIR ESSA PORTA, O ATACANTE PODE SE CONECTAR E FAZER O REVERSE SHELL, EXEMPLO:
# - 
# - [00590]-[39.59.34.145:3410]-[PDST=1337]-[SYN] => [192.168.0.15]
# - [00600]-[192.168.0.15:1337]-[PDST=3410]-[SYN/ACK] => [39.59.34.145] // CONEXÃO ESTABELECIDA COM O HOST DA VÍTIMA COM SUCESSO.
# - [00590]-[39.59.34.145:3410]-[PDST=1337]-[RST] => [192.168.0.15]
# - 
# - E ESSAS SÃO AS DUAS FORMAS DE QUE ESSAS DUAS TÉCNICAS SÃO USADAS EM MALWARES.
# - É USADO TANTO O MODO PASSIVO COMO O MODO ATIVO.
# - NO NOSSO CASO, OU NO NOSSO EXEMPLO, ELE USA O MODO ATIVO, JÁ QUE O MALWARE QUE EXECUTA E GERA TRÁFEGO COM O C2 DO ATACANTE.
# - LEMBRANDO QUE TUDO ISSO SEMPRE SEGUE UM PADRÃO ESPECÍFICO DE PORTAS E TEMPO, OU SEJA, SEMPRE IMPORTA A SEQUÊNCIA E O TEMPO DE
# - ENVIO DE UM PACOTE PRA OUTRO. SE UM PERÍODO MUITO GRANDE ENTRE CADA PORTA, PODE SER QUE NÃO SEJA O KNOCKING PORT.